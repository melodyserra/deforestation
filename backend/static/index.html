<!doctype html>
<html>
    <head>
        <title>Deforestation Tracker</title>
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet/dist/leaflet.css"
        />
        <style>
            #map {
                height: 600px;
            }
        </style>
    </head>
    <body>
        <h1>Deforestation Over Time</h1>
        <div id="map"></div>
        <input
            type="range"
            id="yearSlider"
            min="2000"
            max="2023"
            value="2023"
            step="1"
            oninput="updateYear(this.value)"
        />
        <p>Year: <span id="yearDisplay">2023</span></p>

        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script>
            // Initialize the map
            var map = L.map("map").setView([0, 0], 2); // Set the default view to the globe

            // Add a tile layer (base map)
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "Map data Â© OpenStreetMap contributors",
            }).addTo(map);

            var deforestationLayer = L.layerGroup().addTo(map); // Layer for deforestation points

            // Update the year and fetch data when the slider changes
            function updateYear(year) {
                document.getElementById("yearDisplay").textContent = year; // Update year display

                // Fetch data from the backend
                fetch(`/get_deforestation_data?year=${year}`)
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.json();
                    })
                    .then((data) => {
                        console.log("Fetched Data:", data); // Debugging line
                        updateMap(data); // Call a function to update the map
                    })
                    .catch((error) => {
                        console.error("Error fetching data:", error);
                        alert("Error fetching data: " + error.message);
                    });
            }

            // Function to update the map with deforestation data
            function updateMap(data) {
                deforestationLayer.clearLayers(); // Clear any existing deforestation points

                // Check if data has deforestation areas
                if (
                    data.deforestation_areas &&
                    data.deforestation_areas.length > 0
                ) {
                    // Add new deforestation data
                    data.deforestation_areas.forEach((area) => {
                        console.log(
                            "Rendering deforestation at:",
                            area.lat,
                            area.lon,
                        ); // Debugging line
                        L.circle([area.lat, area.lon], {
                            color: "red",
                            radius: area.deforested_hectares * 100, // Scaled for visibility
                        }).addTo(deforestationLayer);
                    });

                    // Zoom to the first deforestation point (adjust the zoom level as needed)
                    let firstArea = data.deforestation_areas[0];
                    map.setView([firstArea.lat, firstArea.lon], 5); // Zoom level 5 for regional view
                } else {
                    console.log("No deforestation data for this year.");
                }
            }

            // Initial load for the current year (2023 by default)
            updateYear(2023);
        </script>
    </body>
</html>
